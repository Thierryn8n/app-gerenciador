<!DOCTYPE html>
<html>
<head>
    <title>Teste Direto Facebook OAuth</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .info-box {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        .error-box {
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        .success-box {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            border-radius: 4px;
            padding: 15px;
            margin: 15px 0;
        }
        button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover {
            background: #1976d2;
        }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
        }
        .url-test {
            word-break: break-all;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Teste Direto Facebook OAuth</h1>
        
        <div class="info-box">
            <h3>üìã Informa√ß√µes do Teste</h3>
            <p><strong>URL Atual:</strong> <code id="current-url"></code></p>
            <p><strong>Origin:</strong> <code id="current-origin"></code></p>
            <p><strong>Facebook App ID:</strong> <code>1405602787157576</code></p>
            <p><strong>Redirect URI:</strong> <code>https://app-gerenciador-pi.vercel.app/api/auth/facebook/callback</code></p>
        </div>

        <div class="info-box">
            <h3>üåê URL de Teste do Facebook</h3>
            <div class="url-test" id="facebook-url"></div>
            <button onclick="testFacebookAuth()">üöÄ Testar Autentica√ß√£o Facebook</button>
            <button onclick="copyUrl()">üìã Copiar URL</button>
        </div>

        <div class="info-box">
            <h3>üîß Diagn√≥sticos</h3>
            <button onclick="checkEnvironment()">Verificar Ambiente</button>
            <button onclick="testCallback()">Testar Callback</button>
            <button onclick="clearAllCache()">Limpar Cache Completo</button>
        </div>

        <div id="results"></div>

        <div class="error-box">
            <h3>‚ùå Se o Erro Persistir</h3>
            <p><strong>Poss√≠veis Causas:</strong></p>
            <ul>
                <li><strong>Facebook App em Modo Desenvolvimento:</strong> S√≥ funciona para admins</li>
                <li><strong>URL n√£o configurada:</strong> Verifique no Facebook Developers Console</li>
                <li><strong>Cache do Facebook:</strong> Pode levar at√© 30 minutos para propagar</li>
                <li><strong>Permiss√µes:</strong> Verifique se ads_management est√° aprovado</li>
                <li><strong>Dom√≠nio:</strong> Certifique-se que app-gerenciador-pi.vercel.app est√° nos dom√≠nios</li>
            </ul>
        </div>

        <div class="success-box">
            <h3>‚úÖ Checklist Final</h3>
            <ol>
                <li>Facebook App est√° em modo "Live" ou voc√™ √© admin</li>
                <li>URL exata no Facebook: <code>https://app-gerenciador-pi.vercel.app/api/auth/facebook/callback</code></li>
                <li>Dom√≠nio nos "Dom√≠nios do App": <code>app-gerenciador-pi.vercel.app</code></li>
                <li>Cache do navegador limpo</li>
                <li>Testado em aba an√¥nima</li>
                <li>Aguardado 10+ minutos ap√≥s altera√ß√µes</li>
            </ol>
        </div>
    </div>

    <script>
        // Configura√ß√µes
        const FACEBOOK_APP_ID = '1405602787157576';
        const REDIRECT_URI = 'https://app-gerenciador-pi.vercel.app/api/auth/facebook/callback';
        const SCOPE = 'ads_management,ads_read,business_management';
        const STATE = JSON.stringify({ clienteId: 'test-direct' });

        // Construir URL do Facebook
        const facebookUrl = `https://www.facebook.com/v18.0/dialog/oauth?` +
            `client_id=${FACEBOOK_APP_ID}&` +
            `redirect_uri=${encodeURIComponent(REDIRECT_URI)}&` +
            `scope=${encodeURIComponent(SCOPE)}&` +
            `response_type=code&` +
            `state=${encodeURIComponent(STATE)}`;

        // Atualizar informa√ß√µes da p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('current-url').textContent = window.location.href;
            document.getElementById('current-origin').textContent = window.location.origin;
            document.getElementById('facebook-url').textContent = facebookUrl;
        });

        function testFacebookAuth() {
            console.log('üöÄ Iniciando teste de autentica√ß√£o Facebook');
            console.log('URL:', facebookUrl);
            
            // Abrir popup
            const popup = window.open(
                facebookUrl,
                'facebook-auth',
                'width=600,height=600,scrollbars=yes,resizable=yes'
            );

            if (!popup) {
                showResult('‚ùå Popup bloqueado! Permita popups para este site.', 'error');
                return;
            }

            // Listener para mensagens do callback
            const messageHandler = (event) => {
                console.log('üì® Mensagem recebida:', event);
                
                if (event.origin !== 'https://app-gerenciador-pi.vercel.app') {
                    console.log('‚ùå Origin incorreto:', event.origin);
                    return;
                }

                if (event.data.type === 'FACEBOOK_AUTH_SUCCESS') {
                    showResult('‚úÖ Autentica√ß√£o bem-sucedida!', 'success');
                    popup.close();
                } else if (event.data.type === 'FACEBOOK_AUTH_ERROR') {
                    showResult(`‚ùå Erro na autentica√ß√£o: ${event.data.error}`, 'error');
                    popup.close();
                }
                
                window.removeEventListener('message', messageHandler);
            };

            window.addEventListener('message', messageHandler);

            // Timeout para fechar popup
            setTimeout(() => {
                if (!popup.closed) {
                    popup.close();
                    showResult('‚è∞ Timeout - Teste cancelado ap√≥s 2 minutos', 'error');
                    window.removeEventListener('message', messageHandler);
                }
            }, 120000);
        }

        function copyUrl() {
            navigator.clipboard.writeText(facebookUrl).then(() => {
                showResult('üìã URL copiada para a √°rea de transfer√™ncia!', 'success');
            }).catch(() => {
                showResult('‚ùå Erro ao copiar URL', 'error');
            });
        }

        function checkEnvironment() {
            let results = '<h4>üîç Diagn√≥stico do Ambiente:</h4>';
            
            // Verificar HTTPS
            if (window.location.protocol === 'https:') {
                results += '<p>‚úÖ HTTPS: Ativo</p>';
            } else {
                results += '<p>‚ùå HTTPS: Inativo (necess√°rio para produ√ß√£o)</p>';
            }

            // Verificar origem
            if (window.location.origin === 'https://app-gerenciador-pi.vercel.app') {
                results += '<p>‚úÖ Origin: Correto</p>';
            } else {
                results += `<p>‚ö†Ô∏è Origin: ${window.location.origin} (diferente do esperado)</p>`;
            }

            // Verificar suporte a popup
            const testPopup = window.open('', 'test', 'width=1,height=1');
            if (testPopup) {
                testPopup.close();
                results += '<p>‚úÖ Popups: Permitidos</p>';
            } else {
                results += '<p>‚ùå Popups: Bloqueados</p>';
            }

            showResult(results, 'info');
        }

        function testCallback() {
            const callbackUrl = 'https://app-gerenciador-pi.vercel.app/api/auth/facebook/callback?code=test&state=' + encodeURIComponent(STATE);
            window.open(callbackUrl, '_blank');
            showResult('üîó Abrindo callback em nova aba para teste...', 'info');
        }

        function clearAllCache() {
            // Limpar localStorage
            localStorage.clear();
            
            // Limpar sessionStorage
            sessionStorage.clear();
            
            showResult('üßπ Cache local limpo! Recomenda-se tamb√©m limpar o cache do navegador (Ctrl+Shift+Del)', 'success');
        }

        function showResult(message, type) {
            const resultsDiv = document.getElementById('results');
            const className = type === 'error' ? 'error-box' : type === 'success' ? 'success-box' : 'info-box';
            resultsDiv.innerHTML = `<div class="${className}">${message}</div>`;
        }
    </script>
</body>
</html>